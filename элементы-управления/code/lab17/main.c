/*
 * GccApplication15.c
 *
 * Created: 4/23/2025 8:15:30 AM
 * Author : roman
 */ 

#include "main.h"

#define MOSI   3
#define MISO   4
#define SCK  5
#define SS   2

//char buffer[512] ="Selection of RAM is set by the previous address set instruction. If the address set instruction of RAM is not performed before this instruction, the data that has been read first is invalid, as the direction of AC is not yet determined. If RAM data is read several times without RAM address instructions set before, read operation, the correct RAM data can be obtained from the second. But the first data would be incorrect, as there is no time margin to transfer RAM data. In case of DDRAM read operation The..."; //????? ?????? ??? ??????/??????
char buffer2[512] ={}; //????? ?????? ??? ??????
//----------------------------------------
void port_ini(void)
{
	PORTD=0x00;
	DDRD=0xFF;
	PORTB|=(1<<SS)|(1<<MISO)|(1<<MOSI);
	DDRB|=(1<<SS)|(1<<MOSI)|(1<<SCK);
}

void SPI_SendByte (unsigned char byte)
{
	unsigned char i;
	for (i=0;i<8;i++) //???????? ?? ????? ?????
	{
		if ((byte&0x80)==0x00)//????????? ????? ???
		PORTB&=~(1<<MOSI); //???? 0, ?? ?????????? 0 ?? ????
		else PORTB|=(1<<MOSI); //???? 1, ?? ?????????? 1
		byte<<=1; //???????? ?????, ? ??????? ???????? ??? ???????? ?????????? ????
		PORTB|=(1<<SCK); //????? ?? ????? SCK
		asm("nop"); //1 ???? ????????
		PORTB&=~(1<<SCK); //???? ?? ????? SCK
	}
}

unsigned char SPI_ReceiveByte (void)
{
	unsigned char i, result=0;
	for(i=0;i<8;i++)
	{
		PORTB|=(1<<SCK); //????? ?? ????? SCK
		result<<=1; //???????? ?????, ????? ???????? ????? ???
		if ((PINB&(1<<MISO))!=0x00) //??????? ????? ??? (? ??????? ??????)
		result=result|0x01; //??????? ??? ??????
		PORTB&=~(1<<SCK); //???? ?? ????? SCK
		asm("nop"); //1 ???? ????????
	}
	return result;
}

unsigned char SD_cmd(char dt0, char dt1, char dt2, char dt3, char dt4, char dt5) //???????? ??????? (?????? ??????? ??? 40)
{
	unsigned char result;
	long int cnt;
	SPI_SendByte (dt0);		//??????
	SPI_SendByte (dt1);		//????????
	SPI_SendByte (dt2);
	SPI_SendByte (dt3);
	SPI_SendByte (dt4);
	SPI_SendByte (dt5);		//??????????? ?????
	cnt=0;
	do {				//???? ????? ? ??????? R1 (??????? ??? 109)
		result=SPI_ReceiveByte();
		cnt++;
	} while ( ((result&0x80)!=0x00)&&(cnt<0xFFFF) );
	return result;
}

unsigned char SD_Init(void)
{
	unsigned char i, temp;
	long int cnt;
	for (i=0;i<10;i++)			//80 ????????? (?? ????? 74) ??????? ??? 94
	SPI_SendByte(0xFF);
	PORTB&=~(1<<SS);			//???????? SS
	temp=SD_cmd (0x40,0x00,0x00,0x00,0x00,0x95); // CMD0 ??????? ??? 102 ? 96
	if (temp!=0x01) return 3;		//?????, ???? ????? ?? 0?01 (?????????
	SPI_SendByte (0xFF);
	cnt=0;
	do{
		temp=SD_cmd (0x41,0x00,0x00,0x00,0x00,0x95);	//CMD1 (?????????? CMD0, ?????? ?????? ????????)
		SPI_SendByte (0xFF);
		cnt++;
	} while ( (temp!=0x00)&&(cnt<0xFFFF) );		//???? ?????? R1
	if (cnt>=0xFFFF) return 4;
	return 0;
}

unsigned char SD_Write_Block (char* bf, unsigned char dt1, unsigned char dt2, unsigned char dt3, unsigned char dt4)
{
	unsigned char result;
	long int cnt;
	result=SD_cmd(0x58,dt1,dt2,dt3,dt4,0x95);		//CMD24 ??????? ??? 51 ? 97-98
	if (result!=0x00) return 6;			//?????, ???? ????????? ?? 0x00
	SPI_SendByte (0xFF);
	SPI_SendByte (0xFE);				//?????? ??????
	for (cnt=0;cnt<512;cnt++)	SPI_SendByte(bf[cnt]); //??????
	SPI_SendByte (0xFF);				//?????????? ?????
	SPI_SendByte (0xFF);
	result=SPI_ReceiveByte();
	if ((result&0x05)!=0x05) return 6;		//?????, ???? ????????? ?? 0x05 (??????? ??? 111)
	cnt=0;
	do {						//???? ????????? ????????? BUSY
		result=SPI_ReceiveByte();
		cnt++;
	}while ( (result!=0xFF)&&(cnt<0xFFFF) );
	if (cnt>=0xFFFF) return 6;
	return 0;
}

unsigned char SD_Read_Block (char* bf, unsigned char dt1, unsigned char dt2, unsigned char dt3, unsigned char dt4)
{
	unsigned char result;
	long int cnt;
	result=SD_cmd (0x51,dt1,dt2,dt3,dt4,0x95);		//CMD17 ??????? ??? 50 ? 96
	if (result!=0x00) return 5;			//?????, ???? ????????? ?? 0x00
	SPI_SendByte (0xFF);
	cnt=0;
	do{						//???? ?????? ?????
		result=SPI_ReceiveByte();
		cnt++;
	} while ( (result!=0xFE)&&(cnt<0xFFFF) );
	if (cnt>=0xFFFF) return 5;
	for (cnt=0;cnt<512;cnt++)	bf[cnt]=SPI_ReceiveByte(); //???????? ????? ????? ?? ???? ? ?????
	SPI_ReceiveByte();					//???????? ??????????? ?????
	SPI_ReceiveByte();
	return 0;
}


int main(void)
{
	unsigned char i;
	char str[10];
	unsigned char result;
	port_ini();
	LCD_ini();  //?????????????? ???????
	clearlcd();//??????? ???????
	setpos(0,0);
	str_lcd("String 1");
	setpos(2,1);
	str_lcd("String 2");
	setpos(4,2);
	str_lcd("String 3");
	setpos(6,3);
	str_lcd("String 4");
	_delay_ms(1000);
	asm("nop");
	result=SD_Init();
	sprintf(str,"%d",result);
	clearlcd();//??????? ???????
	setpos(0,0);
	str_lcd(str);
	//   	result=SD_Write_Block(buffer,0x00,0x00,0x04,0x00);//??????? ???? ?? ??????
	//  	sprintf(str,"%d",result);
	//   	setpos(0,1);
	//   	str_lcd(str);
	result=SD_Read_Block(buffer2,0x00,0x00,0x04,0x00);	//??????? ???? ? ?????
	sprintf(str,"%d",result);
	setpos(0,2);
	str_lcd(str);
	_delay_ms(1000);
	for (i=0;i<=22;i++)	{str_lcd(buffer2+i*20);_delay_ms(1000);}
	while(1)
	{
	}
}
