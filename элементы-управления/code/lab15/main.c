#include "main.h"
//----------------------------------------
unsigned char sec,min,hour,day,date,month,year;
//----------------------------------------
void port_ini(void)
{
	PORTD=0x00;
	DDRD=0xFF;
}
//----------------------------------------
int main(void)
{
	unsigned int tt=0; //?????????? ??? ???????? ???????????
	
	port_ini(); //?????????????? ?????
	I2C_Init(); //?????????????? ???? I2C
	LCD_ini();  //?????????????? ???????
	clearlcd(); //??????? ???????

	//????????????? ?????
	// 	I2C_StartCondition();
	// 	I2C_SendByte(0b11010000);
	// 	I2C_SendByte(0);//????????? ?? 0x00
	// 	I2C_SendByte(RTC_ConvertFromBinDec(0)); //???????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(31)); //??????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(20)); //????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(5)); //???? ??????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(29)); //????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(1)); //?????
	// 	I2C_SendByte(RTC_ConvertFromBinDec(16)); //???
	//	I2C_StopCondition();
	
	while(1)
	{
		//?????? ???????
		I2C_SendByteByADDR(0,0b11010000);	//????????? ?? ????? 0
		_delay_ms(200);
		I2C_StartCondition(); //???????? ??????? START
		I2C_SendByte(0b11010001); //???????? ? ?????????? ??? ??????
		sec = I2C_ReadByte();
		min = I2C_ReadByte();
		hour = I2C_ReadByte();
		day = I2C_ReadByte();
		date = I2C_ReadByte();
		month = I2C_ReadByte();
		year = I2C_ReadLastByte();
		I2C_StopCondition(); //???????? ??????? STOP
		sec = RTC_ConvertFromDec(sec); //??????????? ? ?????????? ??????
		min = RTC_ConvertFromDec(min); //??????????? ? ?????????? ??????
		hour = RTC_ConvertFromDec(hour); //??????????? ? ?????????? ??????
		day = RTC_ConvertFromDec(day); //??????????? ? ?????????? ??????
		year = RTC_ConvertFromDec(year); //??????????? ? ?????????? ??????
		month = RTC_ConvertFromDec(month); //??????????? ? ?????????? ??????
		date = RTC_ConvertFromDec(date); //??????????? ? ?????????? ??????
		setpos(0,0); //?????? ?????? ?? ?????? ?????????
		sendcharlcd(date/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(date%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd('.');
		sendcharlcd(month/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(month%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd('.');
		sendcharlcd('2');
		sendcharlcd('0');
		sendcharlcd(year/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(year%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(' ');
		sendcharlcd('-');
		sendcharlcd(day+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd('-');
		setpos(0,1); //?????? ?????? ?? ?????? ?????????
		sendcharlcd(hour/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(hour%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(':');
		sendcharlcd(min/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(min%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(':');
		sendcharlcd(sec/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(sec%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(' ');
		tt = converttemp(dt_check()); //???????? ???????????
		sendcharlcd(tt/10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd(tt%10+0x30);//??????????? ????? ? ??? ?????
		sendcharlcd('*');
		sendcharlcd('C');
	}
}
